using System.ComponentModel.Design;
using System.Data;
using System.Drawing;
using System.Text;

namespace _15TextRPG.Source.State
{
    internal class HackState(Func<string, bool> HackingProcess, int limitTimeSec, string[]? _commandList = null) : IGameState
    {
        string[] commandList = _commandList ?? [];

        List<string> commands = [];
        int commandIndex = -1;

        string command = "";

        public void DisplayMenu()
        {
            Console.OutputEncoding = Encoding.UTF8;
            Console.BackgroundColor = ConsoleColor.Black;
            Console.ForegroundColor = ConsoleColor.Green;
            Console.Title = "Hacking in Progress...";
            Console.Clear();

            Console.WriteLine("Hacking in progress...");
            Console.WriteLine("Time Remaining:");

            Console.SetCursorPosition(0, 2);
            Console.WriteLine("ss");
            Console.WriteLine($" {30} sec remaining");
            Console.WriteLine("==========================================");
            Console.Write(">> ");
        }


        public void HandleInput()
        {
            int totalTime = limitTimeSec * 100; // 해킹 제한 시간 (초)
            int barLength = 3000; // 진행 바 길이

            int cursorTop, cursorLeft;

            for (int timeLeft = totalTime; timeLeft >= 0; timeLeft--)
            {
                cursorTop = Console.CursorTop;
                cursorLeft = Console.CursorLeft;
                Console.SetCursorPosition(0, 0);
                Console.WriteLine("Hacking in progress...                                ");
                Console.SetCursorPosition(0, 1);
                Console.WriteLine("Time Remaining:                                       ");
                int filled = (int)((timeLeft / (float)totalTime) * barLength);
                string progressBar = "[" + new string('█', filled / 100) + new string(' ', (barLength - filled) / 100) + "                   ";

                Console.SetCursorPosition(0, 2);
                Console.WriteLine(progressBar);
                Console.WriteLine($" {timeLeft}                                                    ");
                Console.WriteLine("==========================================");
                Console.SetCursorPosition(cursorLeft, cursorTop);


                ConsoleKeyInfo key;
                if (Console.KeyAvailable)
                {
                    key = Console.ReadKey();

                    if (key.Key == ConsoleKey.Enter)
                    {
                        if (HackingProcess(command))
                        {
                            Console.WriteLine("\nHacking Success!");
                            GameManager.Instance.ChangeState(new ExploreState(GameManager.Instance.GameData.CurrentChapter.CurrentStage.Name));
                            return;
                        }
                        if(command.Length > 0) commands.Add(command);
                        Console.WriteLine();
                        command = "";
                        commandIndex = -1;
                        Console.Write(">> ");
                    }
                    else if (key.Key == ConsoleKey.Backspace)
                    {
                        if (command.Length > 0)
                        {
                            command = command.Substring(0, command.Length - 1);

                            Console.SetCursorPosition(Console.CursorLeft, Console.CursorTop);
                            Console.Write(" ");
                            Console.SetCursorPosition(Console.CursorLeft - 1, Console.CursorTop);
                        }
                    }
                    else if (key.Key == ConsoleKey.UpArrow)
                    {
                        if (commands.Count > 0)
                        {
                            if (commands.Count - 1 > commandIndex)
                            {
                                ++commandIndex;
                            }
                            command = commands[commands.Count - 1 - commandIndex];
                            Console.SetCursorPosition(0, Console.CursorTop);
                            Console.Write(new string(' ', Console.WindowWidth));
                            Console.SetCursorPosition(0, Console.CursorTop);
                            Console.Write(">> ");
                            Console.Write(command);
                        }
                    }
                    else if (key.Key == ConsoleKey.DownArrow)
                    {
                        if (commands.Count > 0)
                        {
                            if (commandIndex > 0)
                            {
                                --commandIndex;
                            }
                            command = commands[commands.Count - 1 - commandIndex];
                            Console.SetCursorPosition(0, Console.CursorTop);
                            Console.Write(new string(' ', Console.WindowWidth));
                            Console.SetCursorPosition(0, Console.CursorTop);
                            Console.Write(">> ");
                            Console.Write(command);
                        }
                    }
                    else if (key.Key == ConsoleKey.Tab)
                    {
                        if (command.Length > 0)
                        {
                            foreach (string _ in commandList)
                            {
                                if (_.Contains(command) && _ != command)
                                {
                                    Console.SetCursorPosition(0, Console.CursorTop);
                                    Console.Write(">> " + _);
                                    command = _;
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {
                        command += key.KeyChar;
                    }
                }

                Thread.Sleep(10);
            }

            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine("\r\n\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###$*!;;;;;*$##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=~             ~$#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=-                 -=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:                     :#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#~                       -$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#~                         ~$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#~                           ~#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:                             !@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*   ..                         -$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#~   ~~                          !@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=   ,=:                          :#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#;   ;=,                          .=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$,  -$!                            *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$   ;$~                            *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$  -$*                             *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$  ~#:                             *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$  ~=.                             *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$  ~*     ,:-          .:~         *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$  ~*   .;$#$=,       =$##*-       *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$  ~*   ;@@@@@#.     $@@@@@*.  ~:  *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$. ~*  :@@@@@@@:    .@@@@@@@!  ;;  *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#: ~*  ;@@@@@@@*.   ~@@@@@@@*  ;; .=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@= ~* .*@@@@@@@-     @@@@@@@=. ;; :#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$-~* ,*@@@@@@@,     @@@@@@@$- ;; !@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=;! .*@@@@@@:      .@@@@@@#~ ;**@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:  ;@@@@@=.  :*   ,@@@@@*  ;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#~   ~#@@@-    #@    ,@@@=   ~#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=       .      ~@@               !@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=              #@@,              !@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$.             #@@#              *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=.           ,#@@@            .!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$-.         !$!=$          .,!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=~,       ~            .,!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#;.                 ,;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@!.               ~$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$=#@!.             -$@$$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@; :#@!,           -=#!-~@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@=**#@@@@@@@@@@@@@@@;  !@@$:~~~~~~~~~:$@*  ~@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@=!,  :$@@@@@@@@@@@@@@;  ~#@=!#*@*$*!@!@@#-  ~@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@=,     -#@@@@@@@@@@@@@;   *@- $,#.~. @.@@$   ~@@@@@@@@@@@@@@@@!!!!*@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@#~       :@@@@@@@@@@@@@;   *@*;#!@;;;;@;@@$   :@@@@@@@@@@@@@@@;    .*@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@$:.        ;@@@@@@@@@@@@;   *@@@@@@@@@@@@@@*  .;@@@@@@@@@@@@@@;      .*@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@$:-           =@@@@@@@@@@@!   :#@@@@@@@@@@@@#,  ,=@@@@@@@@@@@@@*        -@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@$-             -@@@@@@@@@@@$-  .=@!#;#;:@#:@@$   -#@@@@@@@@@@@@#,        .*@@@@@@@@@@@@@@@@\r\n@@@@@@@@#:               ~#@@@@@@@@@@:   :#-$,#. @~ @#~   ~@@@@@@@@@@@@@~          .:=@@@@@@@@@@@@@@\r\n@@@@@@@@=.                ~$@@@@@@@@@=-  .~!@*@,*@**@~   ,=@@@@@@@@@@@@:             ,*@@@@@@@@@@@@@\r\n@@@@@@@@!                  ,;@@@@@@@@@;    -~~~.~~~~-    ;@@@@@@@@@@@=~               ,=@@@@@@@@@@@@\r\n@@@@@@@#:       ;,           :@@@@@@@@#~                ,#@@@@@@@@@@;,                 ;@@@@@@@@@@@@\r\n@@@@@@@@!       *$*.          -;@@@@@@@#-              ,$@@@@@@@@@$:                   ,*@@@@@@@@@@@\r\n@@@@@@@@*       .,-*$*          -!@@@@@@#-            .$@@@@@@@@@;,            -        !@@@@@@@@@@@\r\n@@@@@@@@@*,        .,,!=         .-*@@@@@#-          .$@@@@@@@@;,             ;=        ;@@@@@@@@@@@\r\n@@@@@@@@@@#$;.        ..           .-=@@@@##$$$$$$####@@@@@@#:.           :$$:,.       ~#@@@@@@@@@@@\r\n@@@@@@@@@@@@@####=,                  .:#@@@@@@@@@@@@@@@@@@$-.          ~$;...         ,=@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@##:                  !@@@@@@@@@@@@@@@$,                          -=@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@#:                 =@@@@@@@@@@@$.                      ;##@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@#.               .$@@@@@@@#.                   ,#@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@!               -#@@@@.                  =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=.              ;@@                .*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=-              ##.           .!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$:.            .#=.      .:#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$:.            -$!. .-*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=~.            ;=!#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#$~ ;!-.           ,=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=:    .!*~.           -=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=*~        ~*!~            ~=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=*!.            !#:~            ~=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@$******=====*****;.              -~$@@~-           .:*$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@$;,      .....                   -:$@@@@@#~,            -!*=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@$~                             .~;#@@@@@@@@@=:,             .:!!!!!!!**$#@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@!    -~.                     ,:*#@@@@@@@@@@@@@=:.                     .-:!!*#@@@@@@@@@@@@@@@\r\n@@@@@@@#;    -~.                   ,;*@@@@@@@@@@@@@@@@@@*:.                        .:=@@@@@@@@@@@@@@\r\n@@@@@@@@!                        ~;=@@@@@@@@@@@@@@@@@@@@@#*:.    -~                  :@@@@@@@@@@@@@@\r\n@@@@@@@@=.                     :!$@@@@@@@@@@@@@@@@@@@@@@@@@#*!~  --:.          .:-   ~#@@@@@@@@@@@@@\r\n@@@@@@@@#*-      ~.          -*#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$!,  -:,          ~,   ~#@@@@@@@@@@@@@\r\n@@@@@@@@@@$*-    *-         *$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=-  -~-              ~@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@$-   *=!*,    -*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$~  .~;            ,*@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@;   ,;;~.   !$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#;. .-!          ~=@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@#~   ..   -=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#*.  -!==;   ,==#@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@#-     ,=$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=.  ,--,  .$@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@#=;~!=$@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@$.      .=@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#*    .$@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##=##@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n");
            Console.WriteLine("\nHACKING FAILED! SYSTEM SHUTDOWN...");

            Console.ForegroundColor = ConsoleColor.White;
            Console.BackgroundColor = ConsoleColor.Black;
            Console.ReadLine();
        }
    }
}
